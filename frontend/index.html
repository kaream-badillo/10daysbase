<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base Greeter DApp</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #00f2fe, #4facfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        button {
            background: linear-gradient(45deg, #00f2fe, #4facfe);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 242, 254, 0.3);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin: 10px 0;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }
        
        .info {
            background: rgba(33, 150, 243, 0.3);
            border: 1px solid #2196F3;
        }
        
        .contract-info {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Base Greeter DApp</h1>
        <div class="subtitle">Your first smart contract on Base Sepolia!</div>
        
        <!-- Wallet Connection -->
        <div class="card">
            <h3>üîó Wallet Connection</h3>
            <button id="connectBtn" onclick="connectWallet()">Connect MetaMask</button>
            <div id="walletInfo" class="hidden">
                <p><strong>Connected:</strong> <span id="walletAddress"></span></p>
                <p><strong>Network:</strong> <span id="networkName"></span></p>
                <p><strong>Balance:</strong> <span id="balance"></span> ETH</p>
            </div>
        </div>
        
        <!-- Contract Info -->
        <div class="card">
            <h3>üìã Contract Information</h3>
            <div class="contract-info">
                <p><strong>Contract Address:</strong> 0x4BAaE27A22562F3568d1edEf4eb0f3dA02f679b8</p>
                <p><strong>Network:</strong> Base Sepolia (Chain ID: 84532)</p>
                <p><strong>Explorer:</strong> 
                    <a href="https://sepolia.basescan.org/address/0x4BAaE27A22562F3568d1edEf4eb0f3dA02f679b8" 
                       target="_blank" style="color: #4facfe;">View on BaseScan</a>
                </p>
            </div>
        </div>
        
        <!-- Contract Interaction -->
        <div class="card">
            <h3>üí¨ Interact with Greeter</h3>
            
            <div style="margin: 20px 0;">
                <button onclick="readGreeting()">üìñ Read Current Greeting</button>
                <div id="currentGreeting" class="contract-info" style="margin-top: 10px;"></div>
            </div>
            
            <div style="margin: 20px 0;">
                <input type="text" id="newGreeting" placeholder="Enter new greeting..." maxlength="100">
                <button onclick="setGreeting()">‚úèÔ∏è Set New Greeting</button>
            </div>
        </div>
        
        <!-- Status Messages -->
        <div id="statusMessage" class="hidden"></div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = "0x4BAaE27A22562F3568d1edEf4eb0f3dA02f679b8";
        const BASE_SEPOLIA_CHAIN_ID = "0x14a34"; // 84532 in hex
        
        // Contract ABI - simplified for Greeter
        const CONTRACT_ABI = [
            "function greeting() public view returns (string)",
            "function setGreeting(string memory _newGreeting) public"
        ];
        
        let provider;
        let signer;
        let contract;
        
        // Connect to MetaMask
        async function connectWallet() {
            try {
                showStatus("Connecting to MetaMask...", "info");
                
                if (typeof window.ethereum !== 'undefined') {
                    // Request account access
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    // Get account info
                    const address = await signer.getAddress();
                    const balance = await provider.getBalance(address);
                    const network = await provider.getNetwork();
                    
                    // Update UI
                    document.getElementById('walletAddress').textContent = 
                        address.slice(0, 6) + '...' + address.slice(-4);
                    document.getElementById('networkName').textContent = network.name;
                    document.getElementById('balance').textContent = 
                        parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
                    
                    document.getElementById('connectBtn').style.display = 'none';
                    document.getElementById('walletInfo').classList.remove('hidden');
                    
                    // Check if we're on Base Sepolia
                    if (network.chainId !== 84532) {
                        showStatus("‚ö†Ô∏è Please switch to Base Sepolia network!", "error");
                        await switchToBaseSepolia();
                    } else {
                        // Initialize contract
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                        showStatus("‚úÖ Connected successfully to Base Sepolia!", "success");
                        
                        // Auto-read current greeting
                        readGreeting();
                    }
                    
                } else {
                    showStatus("‚ùå MetaMask not found. Please install MetaMask!", "error");
                }
            } catch (error) {
                showStatus(`‚ùå Connection failed: ${error.message}`, "error");
            }
        }
        
        // Switch to Base Sepolia network
        async function switchToBaseSepolia() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
                });
            } catch (switchError) {
                // This error code indicates that the chain has not been added to MetaMask
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_SEPOLIA_CHAIN_ID,
                                chainName: 'Base Sepolia',
                                nativeCurrency: {
                                    name: 'ETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: ['https://sepolia.base.org'],
                                blockExplorerUrls: ['https://sepolia.basescan.org/']
                            }]
                        });
                    } catch (addError) {
                        showStatus(`‚ùå Failed to add Base Sepolia: ${addError.message}`, "error");
                    }
                }
            }
        }
        
        // Read current greeting from contract
        async function readGreeting() {
            try {
                if (!contract) {
                    showStatus("‚ùå Please connect your wallet first!", "error");
                    return;
                }
                
                showStatus("üìñ Reading greeting from contract...", "info");
                const greeting = await contract.greeting();
                
                document.getElementById('currentGreeting').innerHTML = 
                    `<strong>Current Greeting:</strong> "${greeting}"`;
                showStatus("‚úÖ Greeting read successfully!", "success");
                
            } catch (error) {
                showStatus(`‚ùå Failed to read greeting: ${error.message}`, "error");
            }
        }
        
        // Set new greeting
        async function setGreeting() {
            try {
                if (!contract) {
                    showStatus("‚ùå Please connect your wallet first!", "error");
                    return;
                }
                
                const newGreeting = document.getElementById('newGreeting').value.trim();
                if (!newGreeting) {
                    showStatus("‚ùå Please enter a new greeting!", "error");
                    return;
                }
                
                showStatus("‚úèÔ∏è Setting new greeting... (please confirm in MetaMask)", "info");
                
                // Send transaction
                const tx = await contract.setGreeting(newGreeting);
                showStatus(`‚è≥ Transaction sent: ${tx.hash}`, "info");
                
                // Wait for confirmation
                await tx.wait();
                showStatus("‚úÖ Greeting updated successfully!", "success");
                
                // Clear input and refresh greeting
                document.getElementById('newGreeting').value = '';
                readGreeting();
                
            } catch (error) {
                if (error.code === 4001) {
                    showStatus("‚ùå Transaction cancelled by user", "error");
                } else {
                    showStatus(`‚ùå Failed to set greeting: ${error.message}`, "error");
                }
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
            
            // Auto-hide success/info messages after 5 seconds
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }
        
        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // User disconnected
                    document.getElementById('connectBtn').style.display = 'block';
                    document.getElementById('walletInfo').classList.add('hidden');
                    contract = null;
                    showStatus("üëã Wallet disconnected", "info");
                }
            });
            
            window.ethereum.on('chainChanged', function (chainId) {
                // Reload the page when chain changes
                window.location.reload();
            });
        }
    </script>
</body>
</html>
